{% extends "classy_table_base.html" %}

{% macro convert(value, cond, one, two) %}
{% if value|string() == cond %}
{{ one }}
{% else %}
{{ two }}
{% endif %}
{% endmacro%}

{% macro convert_boolean(bool) %}
{{ convert(bool, "True", "yes", "no") }}
{% endmacro %}

{% macro measure_select(id) %}
<div class="btn-group btn-group-justified">
    <div class="btn-group">
        <button id="{{ id }}-min-btn" type="button" class="btn btn-success center">MINIMUM</button>
    </div>
    <div class="btn-group">
        <button id="{{ id }}-avg-btn" type="button" class="btn btn-success center">AVERAGE</button>
    </div>
    <div class="btn-group">
        <button id="{{ id }}-max-btn" type="button" class="btn btn-success center">MAXIMUM</button>
    </div>
</div>
{% endmacro %}

{% macro range_slider(name, min_val=0, max_val=0, min=0, max=1, step=0.01) %}
<div class="col-xs-4 col-lg-3 text-center">
    <p class="text-center">{{ name }}</p>
    <div class="input-row">
        <span>{{ min }}</span>
        <input
            type="text"
            name="{{ name }}"
            data-provide="slider"
            data-slider-min="{{ min }}"
            data-slider-max="{{ max }}"
            data-slider-step="{{ step }}"
            data-slider-value="[{{ min_val }}, {{ max_val }}]"
            data-slider-tooltip="{{ name }}"
        >
        <span>{{ max }}</span>
    </div>
</div>
{% endmacro %}

{% block styles %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='css/bootstrap-slider.min.css') }}">
{{ super() }}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static',filename='js/bootstrap-slider.min.js') }}"></script>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script>
function donutChart(prop, id) {
    var data = [prop*100, 100 - prop*100];

    var width = 80,
        height = 80,
        radius = Math.min(width, height) / 2;

    var arc = d3.svg.arc()
        .outerRadius(radius)
        .innerRadius(radius - 15);

    var pie = d3.layout.pie()
        .sort(null)
        .value(function(d) { return d });

    var svg = d3.select("#" + id).append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var g = svg.selectAll(".arc")
        .data(pie(data))
        .enter().append("g")
        .attr("class", "arc")
        .append("path")
        .attr("d", arc)
        .append('title')
        .text(function(d) {
            return (d.value).toFixed(2) + "%";
        });
}

function switch_measure(id, measure) {
    var measures = ['min', 'avg', 'max'];
    var element = $('#' + id + '-' + measure);
        for (var i = 0; i < measures.length; i++) {
            var temp = $('#' + id + '-' + measures[i]).hide();
            $('#' + id + '-' + measures[i] + '-btn').removeClass('green-bg');            
        }

        element.show();
        $('#' + id + '-' + measure + '-btn').addClass('green-bg');
}
switch_measure('stats', 'avg');
switch_measure('features', 'avg');

{% for measure in stats['energy'] %}
    {% if measure != 'type' %}
        {% for stat in stats %}
            {% if stats[stat]['type'] == 'prop' %}
                donutChart({{ stats[stat][measure] }}, "{{ stat }}-{{ measure }}");
            {% endif %}
        {% endfor %}

        $("#stats-{{ measure }}-btn").click(function() {
        switch_measure('stats', "{{ measure }}")
        });

        $("#features-{{ measure }}-btn").click(function() {
        switch_measure('features', "{{ measure }}")
        });
    {% endif %}
{% endfor %}
</script>
{% endblock %}

{% block classy_content %}
{{ super() }}
{% include 'profile.html' %}
<div class="card col-xs-8">
    <div class="card-content clearfix">
        {{ collapsable_heading("playlist") }}
        <div id="playlist" class="collapsable in">
            <div class="col-xs-6">
            {% if playlist['images'][0] is defined %}
                <img src="{{ playlist['images'][0]['url'] }}">
            {% endif %}
            </div>
            <div class="col-xs-6">
                <table class="classy-table inline-table table">
                    <tbody> 
                        <tr>
                            <td>name</td>
                            <td>{{ playlist['name'] }}</td>
                        </tr>
                        <tr>
                            <td>owner</td>
                            <td>{{ playlist['owner']['id'] }}</td>
                        </tr>
                        <tr>
                            <td>description</td>
                            <td>{{ convert(playlist['description'], "None", "none", playlist['description']) }}</td>
                        </tr>
                        <tr>
                            <td>number of tracks</td>
                            <td>{{ stats['num_tracks']['val'] }}</td>
                        </tr>
                        <tr>
                            <td>collaborative</td>
                            <td>{{ convert_boolean(playlist['collaborative']) }}</td>
                        </tr>
                        <tr>
                            <td>public</td>
                            <td>{{ convert_boolean(playlist['public']) }}</td>
                        </tr>
                        <tr>
                            <td>followers</td>
                            <td>{{ playlist['followers']['total'] }}</td>
                        </tr>
                   </tbody>
                </table> 
            </div>
        </div>
    </div>
</div>
<div class="card col-xs-12">
    <div class="card-content">
        {{ collapsable_heading("tracks") }}
        <div id="tracks" class="collapse in">
            <table id="tracks-table" class="scrollable-table classy-table table clear">
                <thead id="table-head">
                    <tr>
                        <th></th>
                        <th>name</th>
                        <th>album</th>
                        <th>artist</th>
                        <th>explicit</th>
                        <th>duration</th>
                        <th>popularity</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    {% for item in playlist['tracks']['items'] %}
                    <tr>
                        <td>
                        {% if item['track']['album']['images'][0] is defined %}
                            <img src="{{ item['track']['album']['images'][0]['url'] }}">
                        {% endif %}
                        </td>
                        <td>{{ item['track']['name'] }}</td>
                        <td>{{ item['track']['album']['name'] }}</td>
                        <td>
                            {{ item['track']['artists']|join(', ', attribute='name') }}
                        </td>
                        <td>
                            {{ convert_boolean(item['track']['explicit']) }}
                        </td>
                        <td><script type="text/javascript">
                            var millis = {{ item['track']['duration_ms'] }};
                            var minutes = Math.floor(millis / 60000);
                            var seconds = ((millis % 60000) / 1000).toFixed(0);
                            document.write(minutes + ":" + (seconds < 10 ? '0' : '') + seconds);
                        </script></td>
                        <td>{{ item['track']['popularity'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="card col-xs-12 col-md-8">
    <div class="card-content">
        {{ collapsable_heading("features") }}
        <div id="features" class="row collapable in">
            {{ measure_select("features") }}
            {% for measure in stats['energy'] %}
                {% if measure != 'type' %}
                <div id="features-{{ measure }}">
                    {% for stat in stats %}
                        {% if stats[stat]['type'] == 'prop' %}
                        <div id="{{ stat }}-{{ measure }}" class="{{ measure }}-features proportion-donut col-xs-4 col-lg-3">
                            <p class="text-center">{{ stat }}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
<div class="card col-xs-12 col-md-4">
    <div class="card-content">
        {{ collapsable_heading("statistics") }}
        <div id="statistics" class="collapse in">
            {{ measure_select("stats") }}
            {% for measure in stats['energy'] %}
                {% if measure != 'type' %}
                <div id="stats-{{ measure }}">
                    <table class="classy-table inline-table table">
                        <tr>
                            <td>duration</td>
                            <td><script type="text/javascript">
                                var total = {{ stats['duration_ms'][measure] }};
                                var minutes = Math.floor(total / 60);
                                var seconds = (total % 60).toFixed(0);
                                document.write(minutes + ":" + (seconds < 10 ? '0' : '') + seconds);
                            </script></td>
                        </tr>
                        <tr>
                            <td>key</td>
                            <td>{{ stats['key'][measure] }}</td>
                        </tr>
                        <tr>
                            <td>tempo</td>
                            <td>{{ stats['tempo'][measure] }} BPM</td>
                        </tr>
                        <tr>
                            <td>beats per bar</td>
                            <td>{{ stats['time_signature'][measure] }}</td>
                        </tr>
                        <tr>
                            <td>loudness</td>
                            <td>{{ stats['loudness'][measure] }} dB</td>
                        </tr>

                    </table>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</div>
<div class="card col-xs-12">
    <div class="card-content clearfix">
        {{ collapsable_heading("filter") }}
        <div id="filter" class="collapse in">
            <div class="row">
            {% for stat in stats %}
                {% if stats[stat]['type'] == 'prop' %}
                    {{ range_slider(stat, stats[stat]['min'], stats[stat]['max']) }}
                {% endif %}
            {% endfor %}
            {{ range_slider("duration", stats['duration_ms']['min'], stats['duration_ms']['max'], 0, 900, 1) }}
            {{ range_slider("loudness", stats['loudness']['min'], stats['loudness']['max'], -60, 0, 1) }}
            {{ range_slider("beats per bar", stats['time_signature']['min'], stats['time_signature']['max'], 0, 12, 1) }}
            {{ range_slider("tempo", stats['tempo']['min'], stats['tempo']['max'], 0, 200, 1) }}
            </div>
            <a type="button" class="btn btn-success center">FILTER</a>
        </div>
    </div>
</div>
{% endblock %}
